---
title: "Table3 -- Paper on Deaf Depression-free Life Expectancy"
author: "Rafael Rodrigues de Moraes"
date: "2024-11-10"
output:
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning = FALSE)
```

# R Packages

The following packages are needed to load the datasets (`arrow` and
`readr`), applyt the complex survey design (`survey`) to the 
National Health Survey (PNS2019) selected microdata and
prepare the data frames (`dplyr`, `tidyr`) for the analyses in the
paper.

```{r libraries, message=FALSE, warning=FALSE, include=TRUE}
library(readr)     # read_delim
library(tidyr)     # pivot_wider
library(dplyr)     # %>%, filter, select, 
library(gtsummary) # as_gt, style_number, modify_header, gtsave
```

# Importing the processed datasets

## [`br_ibge_censo_2010`] Abridged Life Tables from brazilian census (edition 2010)

```{r br_ibge_censo_2010, include=TRUE}
# Life tables from 2010th Brazilian Population Census (IBGE)
br_ibge_censo_2010 <-
  read_delim(
    file = '/home/rstudio/data/br_ibge_censo_2010/censo2010_lifetables.csv',
    delim = '|',
    show_col_types = FALSE
  )

br_ibge_censo_2010 <-
  br_ibge_censo_2010 %>%
  pivot_wider(
    id_cols = c('age_grp', 'sex')
    ,names_from = 'name'
    ,values_from = 'value'
  ) %>%
  mutate( across( c(lx, Lxn, Ex), as.numeric) )
```

## Importing the baseline dataset
```{r baseline_dataset_import, include=TRUE}
dfle_raw <-
  readRDS(file = '/home/rstudio/data/dfle_baseline_dataset.rds')
```

# Table 3: Comparison by sex, age, and grouped level of hearing impairment of life expectancy and depression-free life expectancy, Brazil

```{r dfle_pns, include=TRUE}
AGE_BREAKS <- c( 0, 1, seq(from=5,to=90, by=5), 1e3)
AGE_LABELS <- c('<1','1-4','5-9','10-14','15-19','20-24','25-29','30-34'
                ,'35-39','40-44','45-49','50-54','55-59','60-64','65-69'
                ,'70-74','75-79','80-84','85-89','90+')

dfle_pns <- dfle_raw %>% 
  as.data.frame(stringsAsFactors = FALSE) %>%
  mutate(
    c008 = as.numeric(c008),
    sex = factor( c006, levels = 1:2, labels = c('male', 'female')),
    libras = factor( g05801, levels = 1:2, labels = c('yes', 'no')),
    age_grp = cut( 
      c008, 
      breaks = AGE_BREAKS,
      labels = AGE_LABELS,
      include.lowest = TRUE,
      right = FALSE
    ),
    combined = case_when(
      g057 == ' ' ~ g058,
      g058 == ' ' ~ g057,
    ),
    hearing_impairment_level = case_when(
      combined %in% c('3', '4') ~ 'Heavily or Fully impaired',
      combined %in% c('1', '2') ~ 'Not or mildly impaired',
      # TRUE ~ 'Ignored or missing information'
    ),
    hearing_impaired = case_when(
      combined == '4' ~ 'Fully impaired',
      combined == '3' ~ 'Heavily impaired',
      combined == '2' ~ 'Mildly impaired',
      combined == '1' ~ 'Not impaired',
      # TRUE ~ 'Ignored or missing information'
    ),
    diagnosed_depression = q092,
    diagnosed_anxiety = q11006,
  ) 

# sample data for demonstration of changes
dfle_pns %>%
  filter(Freq != 0) %>%
  head(5) %>%
  knitr::kable()
```


```{r depr_by_impairment, include=TRUE}
# ever diagnosed with depression by a physician (g058)
depr_by_impairment <- dfle_pns %>%
  na.omit() %>%
  group_by( hearing_impairment_level, age_grp, sex, diagnosed_depression) %>%
  summarise( n = sum( Freq ) ) %>%
  filter( diagnosed_depression != ' ') %>%
  pivot_wider( id_cols = c(1,2,3), names_from = 4, values_from = n) %>% 
  rename( yes = `1`, no = `2`) 

# sample data for demonstration of changes
depr_by_impairment %>%
  filter(no != 0) %>%
  head(5) %>%
  knitr::kable()
```

```{r depr_by_impairment_summary, include=TRUE}
depr_by_impairment <- 
  bind_rows(
    depr_by_impairment,
    depr_by_impairment %>% 
    group_by( hearing_impairment_level, age_grp) %>%
    summarise( yes = sum(yes), no = sum(no)) %>%
    transmute( hearing_impairment_level, age_grp, sex = 'both', yes, no)
  ) %>% 
  mutate(
    pct = ifelse( yes+no== 0, 0, yes / (yes + no))
  ) 

# sample data for demonstration of changes
depr_by_impairment %>%
  filter(no != 0) %>%
  head(5) %>%
  knitr::kable()
```

```{r prevalences, include=TRUE}
prevalences <- 
  bind_rows(
    depr_by_impairment %>%
    mutate( disease = 'depression')
  ) 

# sample data for demonstration of changes
prevalences %>%
  filter(no != 0) %>%
  head(5) %>%
  knitr::kable()
```

```{r dfle_step_1, include=TRUE}
dfle <- 
  prevalences %>% 
  transmute(
    disease, 
    sex, 
    hearing_impairment_level, 
    age_grp, 
    pix = pct, # prevalence of depression by sex, age group and impairment level
    Nx = yes + no # Number in survey in Interval
  ) %>% 
  arrange( disease, sex,hearing_impairment_level, desc(age_grp) ) %>% 
  na.omit() %>% 
  left_join(br_ibge_censo_2010, by = c('age_grp','sex')) %>% 
  mutate(
    aux = (1-pix)*Lxn 
  ) 

# sample data for demonstration of changes
dfle %>% 
  head(5) %>%
  knitr::kable()
```


```{r dfle_step_2, include=TRUE}
table03 <-
  dfle %>% 
  group_by(disease, sex, hearing_impairment_level) %>% 
  transmute( 
    # age group
    # $[x,x+n)$  [1a]
    age_grp = factor( age_grp, levels = AGE_LABELS), 
    # Numbers surviving to age x
    # $l_x$ [6]
    lx, 
    # Person years lived in age interval
    # ${}_n L_x$ [7]
    Lxn, 
    # Total life expectancy
    # $e_x$ [9]
    ex = Ex, 
    # Proportion of age group with depression
    # $\pi_x$ [10]
    pix, 
    # Person years lived without depression from age x
    # $(1-\pi_x)\cdot {}_n L_x$ [11]
    py_wo_depression = (1-pix)*Lxn, 
    # Total years lived without depression from age x
    # $\sum_{x}^{\omega}(1-\pi_x)\cdot{}_n L_x$ [12]
    cumsum_py_wo_depression = cumsum(py_wo_depression),  
    # Depression free life expectancy
    dfle = cumsum(aux)/lx, # ${DFLE}_x$ [13]
    # Number in survey in age interval
    Nx, # $N_x$ [15]
    # Variance of proportion with depression
    S2pix = ifelse( Nx == 0, 0, pix * (1-pix) / Nx), # $S^2(\pi_x)$ [16]
    # 
    L2S2pix = Lxn * Lxn * S2pix, # $L^2\cdot S^2(\pi_x)$ [17]
    # 
    cumsum_L2S2pix = cumsum(L2S2pix), # $\sum_{x}^{\omega} L^2\cdot S^2(\pi_x)$ [18]
    # Variance of DFLEx
    var_dfle = cumsum_L2S2pix / (lx * lx), # $S^2(DFLE_x)$ [19]
    # Standard error of DFLEx
    se_dfle = var_dfle^(1/2), # $\sqrt{S^2(DFLE_x)}$ [19] 
    # Proportion of remaining life spent depression-free
    dfle_over_Ex = dfle / ex, # $\% \frac{{DFLE}_x}{e_x}$
    # Confidence interval for DFLEx
    dfle_inf = round( dfle - 1.96 * se_dfle, 6), # ${DFLE}_x - 1.96\cdot se({DFLE}_x)$
    dfle_sup = round( dfle + 1.96 * se_dfle, 6) # ${DFLE}_x + 1.96\cdot se({DFLE}_x)$
  ) %>%
  arrange( disease, sex, hearing_impairment_level, age_grp ) 

table03 %>% 
  head(10) %>%
  knitr::kable()
```

```{r dfle_step_3, include=TRUE}
table03 %>% 
  filter(
    disease == 'depression',
    age_grp %in% c('<1', '20-24', '40-44','60-64','80-84')
  ) %>%
  mutate(
    age = case_when(
      age_grp == '<1' ~ 0,
      age_grp == '20-24' ~ 20,
      age_grp == '40-44' ~ 40,
      age_grp == '60-64' ~ 60,
      age_grp == '80-84' ~ 80,
    ),
    lint = round(dfle - 1.96*se_dfle, 4),
    lsup = round(dfle + 1.96*se_dfle, 4),
    dfle = round(dfle, 3),
    confint = paste0(dfle, " (", lint , ", ", lsup, ")")
  ) %>% 
  pivot_wider(
    id_cols = c('sex', 'age', 'ex'),
    names_from = 'hearing_impairment_level',
    values_from = 'confint'
  ) %>%
  select( 1,2,3,5,4) %>%
  knitr::kable()
```

# Supplementary Materials - Table 03

```{r dfle_suppl_both, include=TRUE}
suppl_table <- table03 %>% 
  ungroup() %>%
  select(-disease) 

names(suppl_table) <- 
    c("sex", # sex
      "Hearing impairment level", # hearing_impairment_level
      "Age group $[x,x+n)$", # age_grp
      "Numbers surviving to age x $l_{x}$", # lx
      "Person years lived in age interval ${}_{n} L_{x}$", # Lxn
      "Total life expectancy $e_{x}$", # ex
      "Proportion of age group with depression $\\pi_{x}$", # pix
      "Person years lived without depression from age x $(1-\\pi_x)\\cdot {}_n L_x$", # py_wo_depression
      "Total years lived without depression from age x $\\sum_{x}^{\\omega}(1-\\pi_{x})\\cdot {}_{n} L_{x}$", # cumsum_py_wo_depression
      "Depression free life expectancy ${DFLE}_{x}$", # dfle
      "Number in survey in age interval $N_{x}$", # Nx
      "Variance of proportion with depression $S^2(\\pi_{x})$", # S2pix
      "$L^2\\cdot S^2(\\pi_{x})$", # L2S2pix
      "$\\sum_{x}^{\\omega} L^2\\cdot S^2(\\pi_{x})$", # cumsum_L2S2pix
      "Variance of DFLE $S^2({DFLE}_{x})$", # var_dfle
      "Standard error of DFLE $\\sqrt{S^2({DFLE}_{x})}$", # se_dfle
      "Proportion of remaining life spent depression-free $\\% \\frac{{DFLE}_{x}}{e_{x}}$", # dfle_over_Ex
      "Lower Confidence interval for DFLE ${DFLE}_{x} - 1.96\\cdot se({DFLE}_{x})$", # dfle_inf
      "Upper Confidence interval for DFLE ${DFLE}_{x} + 1.96\\cdot se({DFLE}_{x})$" # dfle_sup
    )

options(knitr.table.format = "html")
kable_out <- 
  suppl_table %>% 
  knitr::kable(
    format.args = list(big.mark = " ", decimal.mark = "."),
    digits = c(0, # sex
               0, # hearing_impairment_level
               0, # age_grp
               0, # lx
               0, # Lxn
               2, # ex
               4, # pix
               0, # py_wo_depression
               0, # cumsum_py_wo_depression
               2, # dfle
               0, # Nx
               0, # S2pix
               0, # L2S2pix
               0, # cumsum_L2S2pix
               4, # var_dfle
               4, # se_dfle
               2, # dfle_over_Ex
               2, # dfle_inf
               2  # dfle_sup
               ),
    format = "html",
    escape = TRUE
  ) 

write_file(kable_out,  "kable_out.html")
```

