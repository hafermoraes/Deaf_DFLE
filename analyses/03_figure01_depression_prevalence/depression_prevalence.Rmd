---
title: "Figure01 -- Paper on Deaf Depression-free Life Expectancy"
author: "Rafael Rodrigues de Moraes"
date: "2024-11-10"
output:
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Packages

The following packages are needed to load the datasets (`arrow` and
`readr`), applyt the complex survey design (`survey`) to the 
National Health Survey (PNS2019) selected microdata and
prepare the data frames (`dplyr`, `tidyr`) for the analyses in the
paper.

```{r libraries, message=FALSE, warning=FALSE, include=TRUE}
library(readr)     # read_delim
library(tidyr)     # pivot_wider
library(dplyr)     # %>%, filter, select, 
library(ggplot2)   # geom_point, ggplot
library(ggstats)   # geom_stripped_cols
```

# Importing the baseline dataset
```{r baseline_dataset_import, include=TRUE}
dfle_pns <-
  readRDS(file = '/home/rstudio/data/dfle_baseline_dataset.rds')
```

## Figure 1: Depression prevalence by sex and age band among grouped levels of hearing impairment, Brazil, 2019

```{r dfle_figure01, include=TRUE}
# ever diagnosed with depression by a physician (g058)
depr_by_impairment <- dfle_pns %>%
  na.omit() %>%
  group_by( hearing_impairment_level, age_grp, sex, diagnosed_depression) %>%
  summarise( n = sum( Freq ) ) %>%
  filter( diagnosed_depression != ' ') %>%
  pivot_wider( id_cols = c(1,2,3), names_from = 4, values_from = n) %>% 
  rename( yes = `1`, no = `2`) 

depr_by_impairment <- bind_rows(
  depr_by_impairment,
  depr_by_impairment %>% 
  group_by( hearing_impairment_level, age_grp) %>%
  summarise( yes = sum(yes), no = sum(no)) %>%
  transmute( hearing_impairment_level, age_grp, sex = 'both', yes, no)
) %>% mutate(
    pct = ifelse( yes+no== 0, 0, yes / (yes + no))
  ) 

fig1 <- depr_by_impairment %>%
  filter(!age_grp %in% c('<1','1-4','5-9','10-14')) %>%
  ggplot(
    aes(
      x = age_grp,
      y = pct,
      group = sex,
      colour = hearing_impairment_level
    )
  ) +
  geom_line(
    aes(group = age_grp),
    size = 1,
    color = "grey26",
    alpha = 1
    ) +
  geom_point(size = 4.3, alpha = .8) +
  geom_stripped_cols(color = "white") +
  labs(
    y = 'People diagnosed with depression by a physician'
    ,x = 'Age groups'
    ,group = ''
    ,colour = ''
  ) +
  theme_bw(base_size = 13) +
  theme(
    panel.grid = element_blank(),
    legend.position = 'top'
  )+
  facet_grid(~sex) +
  coord_flip() +
  scale_color_brewer(palette = "Dark2") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 100)
    )

ggsave(
  filename = 'fig01.png',
  plot = fig1,
  width = 7,
  height = 5
)

ggsave(
  filename = 'fig01.pdf',
  plot = fig1,
  width = 7,
  height = 5
)

ggsave(
  filename = 'fig01.svg',
  plot = fig1,
  width = 7,
  height = 5
)

fig1
```

